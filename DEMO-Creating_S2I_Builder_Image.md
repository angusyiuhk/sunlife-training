<!-- Copy and paste the converted output. -->



# Creating an S2I Builder Image


## Download and install source to image


### 1. Download the source to image at github


```
$ https://github.com/openshift/source-to-image/releases/tag/v1.3.1
```



### 2. Untar and copy it to /usr/bin/


```
$ tar zxvf ./source-to-image-v1.3.1-a5a77147-linux-amd64.tar.gz 
$ cp ./s*i /usr/bin/
$ s2i version
s2i v1.3.1
```



## Use the s2i command to create the template files and directories needed for the S2I builder image


### 1. Use the s2i create command to create the template files


```
$ s2i create s2i-httpd s2i-httpd
```



### 2. Verify that the template files have been created


```
$ tree -a ./s2i-httpd/
```



```
./s2i-httpd/
|-- Dockerfile
|-- Makefile
|-- README.md
|-- s2i
|   `-- bin
|       |-- assemble
|       |-- run
|       |-- save-artifacts
|       `-- usage
`-- test
    |-- run
    `-- test-app
        `-- index.html

4 directories, 9 files
```



## Create the Apache HTTP server S2I builder image


### 1. Create below docker file at and overwrite ./s2i-httpd/Dockerfile


```
$ vi ./s2i-httpd/Dockerfile
```



```
FROM registry.access.redhat.com/ubi8/ubi:8.0

# Generic labels
LABEL Component="httpd" \
      Name="s2i-do288-httpd" \
      Version="1.0" \
      Release="1"

# Labels consumed by OpenShift
LABEL io.k8s.description="A basic Apache HTTP Server S2I builder image" \
      io.k8s.display-name="Apache HTTP Server S2I builder image for DO288" \
      io.openshift.expose-services="8080:http" \
      io.openshift.s2i.scripts-url="image:///usr/libexec/s2i"

# This label is used to categorize this image as a builder image in the
# OpenShift web console.
LABEL io.openshift.tags="builder, httpd, httpd24"

# Apache HTTP Server DocRoot
ENV DOCROOT /var/www/html


RUN   yum install -y --nodocs --disableplugin=subscription-manager httpd && \
      yum clean all --disableplugin=subscription-manager -y && \
      echo "This is the default index page from the s2i-do288-httpd S2I builder image." > ${DOCROOT}/index.html

# Change web server port to 8080
RUN sed -i "s/Listen 80/Listen 8080/g" /etc/httpd/conf/httpd.conf

# Copy the S2I scripts to the default location indicated by the
# io.openshift.s2i.scripts-url LABEL (default is /usr/libexec/s2i)
COPY ./s2i/bin/ /usr/libexec/s2i

ENV APP_DIRS /var/www/ /run/httpd/ /etc/httpd/logs/ /var/log/httpd/

RUN chown -R 1001:1001 $APP_DIRS && \
    chgrp -R 0 $APP_DIRS && \
    chmod -R g=u $APP_DIRS && \
    chmod +x /usr/libexec/s2i/assemble /usr/libexec/s2i/run /usr/libexec/s2i/usage

# This default user is created in the rhel7 image
USER 1001

EXPOSE 8080

CMD ["usage"]
```



### 2. Edit the ./s2i-httpd/s2i/bin/assemble as below


```
#!/bin/bash -e
#
# S2I assemble script for the 's2i-do288-httpd' image.
# The 'assemble' script builds your application source so that it is ready to run.
#
# For more information refer to the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

if [[ "$1" == "-h" ]]; then
	# If the 's2i-do288-httpd' assemble script is executed with '-h' flag,
	# print the usage.
	exec /usr/libexec/s2i/usage
fi

echo "---> Copying source files to web server directory..."
cp -Rf /tmp/src/. /var/www/html/
```



### 3. Edit the ./s2i-httpd/s2i/bin/run as below


```
#!/bin/bash -e
#
# S2I run script for the 's2i-do288-httpd' image.
# The run script executes the server that runs your application.
#
# For more information see the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

exec /usr/sbin/httpd -D FOREGROUND
```



### 4. Delete save-artifacts script


```
$ rm ./s2i-httpd/s2i/bin/save-artifacts
```



### 5. Create Apache HTTP server S2I builder image


```
$ cd s2i-httpd
$ sudo podman build -t s2i-httpd .
```



```
STEP 1: FROM registry.access.redhat.com/ubi8/ubi:8.0
...output omitted...
STEP 25: COMMIT s2i-do288-httpd
```



### 6. Verify that the builder image was created


```
$ sudo podman images
```



## Build and test an application container image that combines the Apache HTTP server S2I builder image and the application source code


### 1. Edit the  ./s2i-httpd/test/test-app/index.html as below content


```
This is the index page from the app
```



### 2. Create a new directory for the Dockerfile generated by the s2i build 


```
$ mkdir ~/s2i-sample-app
```



### 3. Build the application container image


```
$ s2i build test/test-app/  s2i-httpd s2i-sample-app  --as-dockerfile ~/s2i-sample-app/Dockerfile
```



### 4. Review the generated application directory


```
$ cd ~/s2i-sample-app; tree
```



```
.
├── Dockerfile
├── downloads
│   ├── defaultScripts
│   └── scripts
└── upload
    ├── scripts
    └── src
        └── index.html

6 directories, 2 files
```



### 5. Review the generated Dockerfile


```
$ cat Dockerfile
```



```
FROM s2i-do288-httpd 1
LABEL "io.k8s.display-name"="s2i-sample-app" \ 2
      "io.openshift.s2i.build.image"="s2i-do288-httpd" \
      "io.openshift.s2i.build.source-location"="test/test-app/"

USER root
# Copying in source code
COPY upload/src /tmp/src 3
# Change file ownership to the assemble user. Builder image must support chown command.
RUN chown -R 1001:0 /tmp/src
USER 1001
# Assemble script sourced from builder image based on user input or image metadata.
# If this file does not exist in the image, the build will fail.
RUN /usr/libexec/s2i/assemble
# Run script sourced from builder image based on user input or image metadata.
# If this file does not exist in the image, the build will fail.
CMD /usr/libexec/s2i/run
```



### 6. Build a test container image from the generated Dockerfile


```
$ sudo podman build  --format docker -t s2i-sample-app .
```



### 7. Verify that the application container image was created:


```
$ sudo podman images
```



```
localhost/s2i-sample-app              latest   3c8637c4372d   About an hour ago
```



### 8. Test the application container image locally 


```
$ sudo podman run --name test -u 1234  -p 8080:8080 -d s2i-sample-app
```



### 9. Verify that the container started 


```
$ sudo podman ps
```



### 10. Use the curl command to test the application


```
$ curl http://localhost:8080
```



```
This is the index page from the app
```



### 11. Stop the local container


```
$ sudo podman stop test
```



## Push the Apache HTTP server S2I builder image to your Quay.io account


### 1. Login to Quay 


```
$ sudo podman login  -u <ur username> quay.io
```



### 2. Use the skopeo copy command to publish the S2I builder image to your Quay.io account


```
$ sudo skopeo copy containers-storage:localhost/s2i-httpd  docker://quay.io/${RHT_OCP4_QUAY_USER}/s2i-httpd

```



## Create an image stream for the Apache HTTP Server S2I builder image


### 1. Login to OCP as developer 


```
$ oc login -u user1 -p 'r3dh4t1!' https://api.cluster-sunlife-2bfb.sunlife-2bfb.sandbox1899.opentlc.com:6443
```



```
The server uses a certificate signed by an unknown authority.
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? (y/n): y

Login successful.

You have access to 273 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project "default".
```



### 2. Create a new project &lt;urname>-apache-s2i


```
$ oc new-project sunny-s2i-apache-s2i
```



```
Now using project "sunny-apache-s2i" on server "https://api.cluster-sunlife-2bfb.sunlife-2bfb.sandbox1899.opentlc.com:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app django-psql-example

to build a new example application in Python. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=gcr.io/hello-minikube-zero-install/hello-node

```



### 3. Log in to your personal Quay.io account 


```
$ podman login  -u <ur name> quay.io
```



### 4. Create a secret from the container registry API access token that was stored by Podman


```
$ oc create secret generic quayio  --from-file .dockerconfigjson=${XDG_RUNTIME_DIR}/containers/auth.json --type=kubernetes.io/dockerconfigjson
```



### 5. Link the new secret to the builder service account.


```
$ oc secrets link builder quayio
```



### 6. Create an image stream by importing the S2I builder image from your Quay.io container registry


```
$ oc import-image s2i-httpd  --from quay.io/<ur name>/s2i-httpd --confirm
```



### 7. Verify that the image stream was created


```
$ oc get is
```



## Deploy and test the html-helloworld application from the classroom Git repository on an OpenShift cluster


### 1. Create a new application called hello from sources in Git


```
$ oc new-app --as-deployment-config  --name hello-s2i  s2i-httpd~https://github.com/<ur name>/sunlife-triaining  --context-dir=developer-src/html-helloworld
```



```
--> Found image c7a496d (2 hours old) in image stream "youruser-apache-s2i/s2i-do288-httpd" under tag "latest" for "s2i-do288-httpd"

    Apache HTTP Server S2I builder image for DO288
    ----------------------------------------------
    A basic Apache HTTP Server S2I builder image
...output omitted...
--> Creating resources ...
...output omitted...
--> Success
...output omitted...
```



### 2. View the build logs. 


```
$ oc logs -f bc/hello-s2i
```



```
Cloning "https://github.com/youruser/xxxxx" ...
...output omitted...
---> Copying source files to web server directory...
Pushing image-registry.openshift-image-registry.svc:5000/youruser-apache-s2i/hello-s2i:latest ...
...output omitted...
Push successful
```



### 3. Wait until the application is deployed


```
$  oc get pod
```



### 4. Expose the application for external access by using a route


```
$  oc expose svc hello-s2i
```



### 5. Obtain the route URL using the oc get route


```
$  oc get route/hello-s2i -o jsonpath='{.spec.host}{"\n"}'
```



### 6. Test the application using the route URL


```
$  curl http://<the route>
```



## Clean up


```
$ oc delete project  <urname>-apache-s2i
```


